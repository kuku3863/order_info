# 订单管理系统 - 数据库管理指南

## 目录
1. [数据库配置说明](#数据库配置说明)
2. [环境切换方法](#环境切换方法)
3. [数据库备份](#数据库备份)
4. [数据库恢复](#数据库恢复)
5. [常见问题](#常见问题)

---

## 数据库配置说明

### 数据库文件位置
项目根目录下包含以下数据库文件：
- `data-dev.sqlite` - 开发环境数据库（默认）
- `data.sqlite` - 生产环境数据库
- `data-test.sqlite` - 测试环境数据库（自动创建）

### 配置文件结构
在 `config.py` 中定义了三种环境配置：

```python
class DevelopmentConfig(Config):
    SQLALCHEMY_DATABASE_URI = 'sqlite:///data-dev.sqlite'

class ProductionConfig(Config):
    SQLALCHEMY_DATABASE_URI = 'sqlite:///data.sqlite'

class TestingConfig(Config):
    SQLALCHEMY_DATABASE_URI = 'sqlite:///data-test.sqlite'
```

---

## 环境切换方法

### 方法一：环境变量控制（推荐）

**Windows PowerShell：**
```powershell
# 切换到开发环境（默认）
$env:FLASK_CONFIG = "development"
python manage.py runserver

# 切换到生产环境
$env:FLASK_CONFIG = "production"
python manage.py runserver

# 切换到测试环境
$env:FLASK_CONFIG = "testing"
python manage.py runserver
```

**Windows CMD：**
```cmd
# 切换到生产环境
set FLASK_CONFIG=production
python manage.py runserver

# 切换到开发环境
set FLASK_CONFIG=development
python manage.py runserver
```

### 方法二：修改代码（临时）

编辑 `manage.py` 文件第8行：
```python
# 原代码
app = create_app(os.getenv('FLASK_CONFIG') or 'default')

# 修改为强制使用生产环境
app = create_app('production')

# 修改为强制使用开发环境
app = create_app('development')
```

---

## 数据库备份

### 自动备份（推荐）
1. 登录管理员账户
2. 点击菜单栏 "管理" → "数据库备份"
3. 确认备份操作
4. 备份文件自动生成，格式：`数据库名_YYYYMMDDHHMMSS.sqlite`

### 手动备份
```powershell
# 备份当前使用的数据库
copy data.sqlite "data_backup_$(Get-Date -Format 'yyyyMMddHHmmss').sqlite"

# 备份开发数据库
copy data-dev.sqlite "data-dev_backup_$(Get-Date -Format 'yyyyMMddHHmmss').sqlite"
```

---

## 数据库恢复

### ⚠️ 重要提醒
- **恢复前务必停止服务器**
- **建议先备份当前数据库**
- **确保备份文件完整且未损坏**

### 方法一：直接替换（推荐）

```powershell
# 1. 停止服务器（Ctrl+C）

# 2. 备份当前数据库（可选）
copy data.sqlite "data_current_backup_$(Get-Date -Format 'yyyyMMddHHmmss').sqlite"

# 3. 用备份文件替换当前数据库
copy "data_20250730164705.sqlite" data.sqlite

# 4. 重启服务器
python manage.py runserver
```

### 方法二：重命名法

```powershell
# 1. 停止服务器

# 2. 重命名备份文件
rename "data_20250730164705.sqlite" "data.sqlite"

# 3. 重启服务器
python manage.py runserver
```

### 方法三：修改配置文件

1. 停止服务器
2. 编辑 `config.py` 文件：

```python
class ProductionConfig(Config):
    SQLALCHEMY_DATABASE_URI = 'sqlite:///' + os.path.join(basedir, 'data_20250730164705.sqlite')
```

3. 重启服务器

### 方法四：环境变量指定

```powershell
# 通过环境变量指定数据库文件
$env:DATABASE_URL = "sqlite:///D:\桌面\学习\data_20250730164705.sqlite"
$env:FLASK_CONFIG = "production"
python manage.py runserver
```

---

## 常见问题

### Q1: 如何查看当前使用的是哪个数据库？
A: 查看服务器启动日志，或在应用中添加调试信息显示当前数据库路径。

### Q2: 备份文件在哪里？
A: 备份文件默认保存在项目根目录下，与原数据库文件同级。

### Q3: 恢复后数据丢失怎么办？
A: 如果事先做了备份，可以使用备份文件再次恢复。建议恢复前总是先备份当前数据。

### Q4: 如何在不同环境间迁移数据？
A: 可以将一个环境的数据库文件复制并重命名为另一个环境的数据库文件名。

### Q5: 数据库文件损坏怎么办？
A: 使用最近的备份文件恢复，这就是为什么定期备份很重要。

---

## 最佳实践

1. **定期备份**：建议每天或每周进行数据库备份
2. **多重备份**：保留多个时间点的备份文件
3. **测试恢复**：定期测试备份文件的完整性
4. **环境隔离**：开发和生产环境使用不同的数据库
5. **权限控制**：只有管理员才能执行备份和恢复操作

---

## 快速参考

### 常用命令
```powershell
# 启动开发环境
$env:FLASK_CONFIG = "development"
python manage.py runserver

# 启动生产环境
$env:FLASK_CONFIG = "production"
python manage.py runserver

# 快速备份
copy data.sqlite "backup_$(Get-Date -Format 'yyyyMMddHHmmss').sqlite"

# 快速恢复
copy "backup_文件名.sqlite" data.sqlite
```

### 文件说明
- `config.py` - 数据库配置文件
- `manage.py` - 应用启动文件
- `data-dev.sqlite` - 开发数据库
- `data.sqlite` - 生产数据库
- `数据库管理指南.md` - 本文档

---

*最后更新：2025年1月30日*