{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}订单列表{% endblock %}

{% block page_content %}
<div class="page-header">
    <h1>订单列表</h1>
</div>

<!-- 筛选表单 -->
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">筛选条件</h3>
            </div>
            <div class="panel-body">
                <form method="GET">
                    <div class="row">
                        {% if current_user.can(Permission.VIEW_ALL) %}
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="user_id" class="control-label"><i class="glyphicon glyphicon-user"></i> 提交用户</label>
                                <select name="user_id" id="user_id" class="form-control">
                                    <option value="">全部用户</option>
                                    {% for user in users %}
                                    <option value="{{ user.id }}" {% if current_filters.user_id == user.id %}selected{% endif %}>
                                        {{ user.username }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="start_date" class="control-label"><i class="glyphicon glyphicon-calendar"></i> 开始日期</label>
                                <input type="date" name="start_date" id="start_date" class="form-control" 
                                       value="{{ current_filters.start_date or '' }}">
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="end_date" class="control-label"><i class="glyphicon glyphicon-calendar"></i> 结束日期</label>
                                <input type="date" name="end_date" id="end_date" class="form-control" 
                                       value="{{ current_filters.end_date or '' }}">
                            </div>
                        </div>
                        
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="search_type" class="control-label"><i class="glyphicon glyphicon-search"></i> 搜索类型</label>
                                <select name="search_type" id="search_type" class="form-control">
                                    <option value="order_code" {{ 'selected' if current_filters.search_type == 'order_code' else '' }}>订单编码</option>
                                    <option value="wechat_name" {{ 'selected' if current_filters.search_type == 'wechat_name' or not current_filters.search_type else '' }}>微信名</option>
                                    <option value="wechat_id" {{ 'selected' if current_filters.search_type == 'wechat_id' else '' }}>微信号</option>
                                    <option value="phone" {{ 'selected' if current_filters.search_type == 'phone' else '' }}>手机号</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="search_value" class="control-label"><i class="glyphicon glyphicon-edit"></i> 搜索内容</label>
                                <input type="text" name="search_value" id="search_value" class="form-control" 
                                       placeholder="输入搜索内容" value="{{ current_filters.search_value or '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        
                        <div class="col-md-7">
                            <div class="form-group">
                                <label class="control-label" style="visibility: hidden;">操作</label>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="glyphicon glyphicon-search"></i> 筛选
                                    </button>
                                    <a href="{{ url_for('main.order_list') }}" class="btn btn-default">
                                        <i class="glyphicon glyphicon-refresh"></i> 重置
                                    </a>
                                    <small class="text-muted" style="margin-left: 15px;">
                                        <i class="glyphicon glyphicon-info-sign"></i> 
                                        提示：支持按订单编码、微信名、微信号、手机号模糊搜索
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 统计信息 -->
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="glyphicon glyphicon-stats"></i> 统计信息</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-primary"><i class="glyphicon glyphicon-list-alt"></i></h3>
                            <h4 class="text-primary">{{ pagination.total }}</h4>
                            <p class="text-muted">订单数量</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-info"><i class="glyphicon glyphicon-th-large"></i></h3>
                            <h4 class="text-info">{{ total_quantity }}</h4>
                            <p class="text-muted">数量总数</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-warning"><i class="glyphicon glyphicon-user"></i></h3>
                            <h4 class="text-warning">{{ total_wechat_users }}</h4>
                            <p class="text-muted">微信用户数</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-success"><i class="glyphicon glyphicon-yen"></i></h3>
                            <h4 class="text-success">￥{{ "%.2f"|format(total_amount) }}</h4>
                            <p class="text-muted">总金额</p>
                        </div>
                    </div>
                </div>
                
                <!-- 详细统计按钮 -->
                <div class="row" style="margin-top: 15px;">
                    <div class="col-md-12">
                        <div class="text-center">
                            {% if current_user.can(Permission.VIEW_ALL) %}
                            <a href="{{ url_for('main.order_statistics', **current_filters) }}" class="btn btn-info btn-lg">
                                <i class="glyphicon glyphicon-signal"></i> 详细统计
                            </a>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="glyphicon glyphicon-time"></i> 今日：{{ now.strftime('%m-%d') }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading" style="background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); border: none; padding: 20px;">
                <div class="row">
                    <div class="col-md-6">
                        <h3 class="panel-title" style="color: white; font-size: 20px; font-weight: 600; margin: 0; display: flex; align-items: center;">
                            <i class="glyphicon glyphicon-list-alt" style="margin-right: 10px; color: #68d391;"></i>
                            订单信息管理
                        </h3>
                    </div>
                    <div class="col-md-6 text-right">
                        <div class="btn-group" role="group" style="display: flex; gap: 8px; justify-content: flex-end;">
                            <a href="{{ url_for('main.new_order') }}" class="btn btn-sm" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 8px; transition: all 0.3s; text-decoration: none; font-weight: 500;" onmouseover="this.style.background='#38a169'; this.style.transform='translateY(-1px)';" onmouseout="this.style.background='#48bb78'; this.style.transform='translateY(0)';">
                                <i class="glyphicon glyphicon-plus"></i> 新建订单
                            </a>
                            <a href="{{ url_for('main.import_orders') }}" class="btn btn-sm" style="background: #4299e1; color: white; border: none; padding: 8px 16px; border-radius: 8px; transition: all 0.3s; text-decoration: none; font-weight: 500;" onmouseover="this.style.background='#3182ce'; this.style.transform='translateY(-1px)';" onmouseout="this.style.background='#4299e1'; this.style.transform='translateY(0)';">
                                <i class="glyphicon glyphicon-upload"></i> 批量导入
                            </a>
                            <a href="{{ url_for('main.export_orders', **current_filters) }}" class="btn btn-sm" style="background: #ed8936; color: white; border: none; padding: 8px 16px; border-radius: 8px; transition: all 0.3s; text-decoration: none; font-weight: 500;" onmouseover="this.style.background='#dd6b20'; this.style.transform='translateY(-1px)';" onmouseout="this.style.background='#ed8936'; this.style.transform='translateY(0)';">
                                <i class="glyphicon glyphicon-download"></i> 导出订单
                            </a>
                            <a href="{{ url_for('main.export_template') }}" class="btn btn-sm" style="background: #805ad5; color: white; border: none; padding: 8px 16px; border-radius: 8px; transition: all 0.3s; text-decoration: none; font-weight: 500;" onmouseover="this.style.background='#6b46c1'; this.style.transform='translateY(-1px)';" onmouseout="this.style.background='#805ad5'; this.style.transform='translateY(0)';">
                                <i class="glyphicon glyphicon-file"></i> 下载模板
                            </a>
                            {% if current_user.can(Permission.ADMIN) %}
                             <button id="batchStatusBtn" class="btn btn-sm" style="background: #805ad5; color: white; border: none; padding: 8px 16px; border-radius: 8px; transition: all 0.3s; font-weight: 500; display: none; margin-right: 8px;" onmouseover="this.style.background='#6b46c1'; this.style.transform='translateY(-1px)';" onmouseout="this.style.background='#805ad5'; this.style.transform='translateY(0)';">
                                 <i class="glyphicon glyphicon-flag"></i> 批量修改状态
                             </button>
                             <button id="batchDeleteBtn" class="btn btn-sm" style="background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 8px; transition: all 0.3s; font-weight: 500; display: none;" onmouseover="this.style.background='#c53030'; this.style.transform='translateY(-1px)';" onmouseout="this.style.background='#e53e3e'; this.style.transform='translateY(0)';">
                                 <i class="glyphicon glyphicon-trash"></i> 批量删除
                             </button>
                             {% endif %}

                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-body" style="padding: 0 !important;">
                <div class="table-responsive" style="padding: 0 !important;">
                    <table class="table table-striped table-hover table-bordered">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                            <tr>
                                {% if current_user.can(Permission.ADMIN) %}
                                <th class="text-center" style="padding: 15px 4px 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle; width: 45px; min-width: 45px;">
                                    <input type="checkbox" id="selectAll" title="全选/取消全选" style="transform: scale(1.2);">
                                </th>
                                {% endif %}
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle; width: 120px; min-width: 120px;">
                                    <i class="glyphicon glyphicon-barcode" style="margin-right: 6px; color: #ffd700;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">订单编码</div>
                                </th>
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle;">
                                    <i class="glyphicon glyphicon-tag" style="margin-right: 6px; color: #98fb98;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">订单类型</div>
                                </th>
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle; width: 140px; min-width: 140px;">
                                    <i class="glyphicon glyphicon-comment" style="margin-right: 6px; color: #87ceeb;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">微信名</div>
                                </th>

                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle;">
                                    <i class="glyphicon glyphicon-phone" style="margin-right: 6px; color: #ffa07a;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">手机号</div>
                                </th>
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle;">
                                    <i class="glyphicon glyphicon-calendar" style="margin-right: 6px; color: #f0e68c;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">完成时间</div>
                                </th>
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle;">
                                    <i class="glyphicon glyphicon-shopping-cart" style="margin-right: 6px; color: #90ee90;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">数量</div>
                                </th>
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle;">
                                    <i class="glyphicon glyphicon-yen" style="margin-right: 6px; color: #ffd700;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">金额</div>
                                </th>
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle; width: 80px; min-width: 80px;">
                                    <i class="glyphicon glyphicon-edit" style="margin-right: 6px; color: #ffb6c1;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">备注</div>
                                </th>
                                {% for field in custom_fields %}
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle;">
                                    <i class="glyphicon glyphicon-list-alt" style="margin-right: 6px; color: #add8e6;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">{{ field.name }}</div>
                                    <small style="color: #e6e6fa; font-size: 10px; display: block; margin-top: 1px;">
                                        ({% if field.field_type == 'text' %}文本{% elif field.field_type == 'number' %}数字{% elif field.field_type == 'date' %}日期{% elif field.field_type == 'image' %}图片{% else %}{{ field.field_type }}{% endif %})
                                    </small>
                                </th>
                                {% endfor %}
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle;">
                                    <i class="glyphicon glyphicon-time" style="margin-right: 6px; color: #ffa500;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">创建时间</div>
                                </th>
                                {% if current_user.can(Permission.ADMIN) %}
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle;">
                                    <i class="glyphicon glyphicon-user" style="margin-right: 6px; color: #98fb98;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">提交用户</div>
                                </th>
                                {% endif %}
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle;">
                                    <i class="glyphicon glyphicon-flag" style="margin-right: 6px; color: #ff6b6b;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">订单状态</div>
                                </th>
                                <th class="text-center" style="padding: 15px 8px; border-bottom: 3px solid #5a67d8; vertical-align: middle; width: 180px; min-width: 180px;">
                                    <i class="glyphicon glyphicon-cog" style="margin-right: 6px; color: #dcdcdc;"></i>
                                    <div style="font-size: 13px; margin-top: 2px;">操作</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr style="transition: all 0.3s ease; border-left: 4px solid transparent;" onmouseover="this.style.borderLeft='4px solid #667eea'; this.style.backgroundColor='#f8f9ff';" onmouseout="this.style.borderLeft='4px solid transparent'; this.style.backgroundColor='';">
                                {% if current_user.can(Permission.ADMIN) %}
                                <td class="text-center" style="padding: 12px 4px 12px 8px; width: 45px; min-width: 45px;">
                                    <input type="checkbox" class="order-checkbox" data-order-id="{{ order.id }}" style="transform: scale(1.2);">
                                </td>
                                {% endif %}
                                <td class="text-center" style="padding: 12px 8px; font-weight: 500; color: #2d3748;"><span style="background: #e2e8f0; padding: 4px 8px; border-radius: 4px; font-family: monospace;">{{ order.order_code }}</span></td>
                                <td class="text-center" style="padding: 12px 8px;"><span class="label" style="background: #4299e1; color: white; padding: 4px 8px; border-radius: 12px;">{{ order.order_type.name if order.order_type else '未分类' }}</span></td>
                                <td class="text-center" style="padding: 12px 8px; font-weight: 500; color: #2d3748;">{{ order.wechat_name }}</td>

                                <td class="text-center" style="padding: 12px 8px; font-family: monospace; color: #2d3748;">{{ order.phone or '-' }}</td>
                                <td class="text-center" style="padding: 12px 8px; color: #4a5568;">{{ order.completion_time.strftime('%Y-%m-%d') if order.completion_time else '-' }}</td>
                                <td class="text-center" style="padding: 12px 8px;"><span style="background: #68d391; color: white; padding: 2px 8px; border-radius: 10px; font-weight: 500;">{{ order.quantity }}</span></td>
                                <td class="text-center" style="padding: 12px 8px; font-weight: 600; color: #e53e3e;">￥{{ order.amount }}</td>
                                <td class="text-center" style="padding: 12px 8px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #718096;" title="{{ order.notes or '' }}">{{ order.notes or '-' }}</td>
                                {% for field in custom_fields %}
                                <td class="text-center" style="padding: 12px 8px; color: #4a5568;">{{ order.get_custom_field(field.name) or '-' }}</td>
                                {% endfor %}
                                <td class="text-center" style="padding: 12px 8px; font-size: 12px; color: #718096;">{{ order.create_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                {% if current_user.can(Permission.ADMIN) %}
                                <td class="text-center" style="padding: 12px 8px;">
                                    {% set user_colors = ['#4299e1', '#48bb78', '#ed8936', '#805ad5', '#e53e3e', '#38b2ac', '#d69e2e', '#f56565', '#9f7aea', '#38a169'] %}
                                    {% set color_index = (order.creator.id if order.creator else 0) % user_colors|length %}
                                    <span class="label" style="background: {{ user_colors[color_index] }}; color: white; padding: 4px 8px; border-radius: 12px;">{{ order.creator.username if order.creator else '未知用户' }}</span>
                                </td>
                                {% endif %}
                                <td class="text-center" style="padding: 12px 8px;">
                                    {% if current_user.can(Permission.ADMIN) %}
                                        {% if order.status == '已结算' %}
                                        <span class="label status-clickable" data-order-id="{{ order.id }}" data-current-status="{{ order.status }}" style="background: #48bb78; color: white; padding: 4px 8px; border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#38a169';" onmouseout="this.style.background='#48bb78';">{{ order.status }}</span>
                                        {% elif order.status == '未结算' %}
                                        <span class="label status-clickable" data-order-id="{{ order.id }}" data-current-status="{{ order.status }}" style="background: #ed8936; color: white; padding: 4px 8px; border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dd6b20';" onmouseout="this.style.background='#ed8936';">{{ order.status }}</span>
                                        {% else %}
                                        <span class="label status-clickable" data-order-id="{{ order.id }}" data-current-status="{{ order.status or '未完成' }}" style="background: #a0aec0; color: white; padding: 4px 8px; border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#718096';" onmouseout="this.style.background='#a0aec0';">{{ order.status or '未完成' }}</span>
                                        {% endif %}
                                    {% else %}
                                        {% if order.status == '已结算' %}
                                        <span class="label" style="background: #48bb78; color: white; padding: 4px 8px; border-radius: 12px;">{{ order.status }}</span>
                                        {% elif order.status == '未结算' %}
                                        <span class="label" style="background: #ed8936; color: white; padding: 4px 8px; border-radius: 12px;">{{ order.status }}</span>
                                        {% else %}
                                        <span class="label" style="background: #a0aec0; color: white; padding: 4px 8px; border-radius: 12px;">{{ order.status or '未完成' }}</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="text-center" style="padding: 12px 8px;">
                                    <div class="btn-group" role="group" style="display: flex; gap: 4px; justify-content: center;">
                                        <a href="{{ url_for('main.view_order', id=order.id) }}" class="btn btn-xs" title="查看详情" style="background: #4299e1; color: white; border: none; padding: 6px 10px; border-radius: 6px; transition: all 0.2s; text-decoration: none;" onmouseover="this.style.background='#3182ce';" onmouseout="this.style.background='#4299e1';">
                                            <i class="glyphicon glyphicon-eye-open"></i>
                                        </a>
                                        <a href="{{ url_for('main.edit_order', id=order.id) }}" class="btn btn-xs" title="编辑订单" style="background: #48bb78; color: white; border: none; padding: 6px 10px; border-radius: 6px; transition: all 0.2s; text-decoration: none;" onmouseover="this.style.background='#38a169';" onmouseout="this.style.background='#48bb78';">
                                            <i class="glyphicon glyphicon-edit"></i>
                                        </a>
                                        {% if current_user.can(Permission.ADMIN) %}
                                        <button class="btn btn-xs" title="修改状态" onclick="showStatusModal({{ order.id }}, '{{ order.status }}')" style="background: #805ad5; color: white; border: none; padding: 6px 10px; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#6b46c1';" onmouseout="this.style.background='#805ad5';">
                                            <i class="glyphicon glyphicon-flag"></i>
                                        </button>
                                        {% endif %}
                                        {% if current_user.can(Permission.ADMIN) or order.user_id == current_user.id %}
                                        <button class="btn btn-xs delete-order" data-id="{{ order.id }}" title="删除订单" style="background: #f56565; color: white; border: none; padding: 6px 10px; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#e53e3e';" onmouseout="this.style.background='#f56565';">
                                            <i class="glyphicon glyphicon-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% if current_user.can(Permission.ADMIN) and order.user_id != current_user.id %}
                                    <div style="margin-top: 6px;"><span class="label" style="background: #ed8936; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px;"><i class="glyphicon glyphicon-warning-sign"></i> 他人订单</span></div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="{{ (11 + custom_fields|length + (1 if current_user.can(Permission.ADMIN) else 0) + (1 if current_user.can(Permission.ADMIN) else 0)) }}" class="text-center" style="padding: 60px 20px; background: #f8f9fa;">
                                    <div style="color: #a0aec0; font-size: 16px;">
                                        <i class="glyphicon glyphicon-inbox" style="font-size: 48px; margin-bottom: 15px; display: block; color: #cbd5e0;"></i>
                                        <div style="font-weight: 500; margin-bottom: 8px;">暂无订单数据</div>
                                        <div style="font-size: 14px; color: #718096;">您可以点击上方的"新建订单"按钮来创建第一个订单</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% if pagination %}
            <div class="panel-footer">
                <div class="pagination">
                    {{ macros.pagination_widget(pagination, 'main.order_list') }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" style="z-index: 1060;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="deleteModalLabel">确认删除</h4>
            </div>
            <div class="modal-body">
                <p>确定要删除这个订单吗？此操作不可恢复。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 修改订单状态模态框 -->
<div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="statusModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="statusModalLabel">修改订单状态</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="orderStatus">选择新状态：</label>
                    <select class="form-control" id="orderStatus">
                        <option value="未完成">未完成</option>
                        <option value="未结算">未结算</option>
                        <option value="已结算">已结算</option>
                    </select>
                </div>
                <p class="text-muted">当前状态：<span id="currentStatus"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmStatusUpdate">确认修改</button>
            </div>
        </div>
    </div>
</div>

<!-- 批量修改状态模态框 -->
<div class="modal fade" id="batchStatusModal" tabindex="-1" role="dialog" aria-labelledby="batchStatusModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="batchStatusModalLabel">批量修改订单状态</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="batchOrderStatus">选择新状态：</label>
                    <select class="form-control" id="batchOrderStatus">
                        <option value="未完成">未完成</option>
                        <option value="未结算">未结算</option>
                        <option value="已结算">已结算</option>
                    </select>
                </div>
                <p class="text-muted">将修改 <span id="selectedCount">0</span> 个订单的状态</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBatchStatusUpdate">确认修改</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function() {
        var orderId;
        var statusOrderId;
        
        $('.delete-order').click(function() {
            orderId = $(this).data('id');
            $('#deleteModal').modal('show');
        });
        
        $('#confirmDelete').click(function() {
            // 获取CSRF token
            var csrfToken = $('meta[name=csrf-token]').attr('content');
            if (!csrfToken) {
                csrfToken = $('input[name="csrf_token"]').val();
            }
            
            $.ajax({
                url: '{{ url_for("main.delete_order", id=0) }}'.replace('0', orderId),
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(result) {
                    if (result.success) {
                        $('#deleteModal').modal('hide');
                        location.reload();
                    } else {
                        alert('删除失败：' + (result.error || '未知错误'));
                    }
                },
                error: function(xhr, status, error) {
                    console.log('删除订单失败:', xhr.responseText);
                    alert('删除失败，请检查网络连接或联系管理员');
                }
            });
        });
        
        // 修改订单状态相关函数
        window.showStatusModal = function(id, currentStatus) {
            statusOrderId = id;
            $('#currentStatus').text(currentStatus || '未完成');
            $('#orderStatus').val(currentStatus || '未完成');
            $('#statusModal').modal('show');
        };
        
        // 一键修改状态功能
        $('.status-clickable').click(function() {
            var orderId = $(this).data('order-id');
            var currentStatus = $(this).data('current-status');
            var statusMap = {
                '未完成': '未结算',
                '未结算': '已结算',
                '已结算': '未完成'
            };
            var newStatus = statusMap[currentStatus] || '未完成';
            
            // 直接更新状态
            $.ajax({
                url: '{{ url_for("main.update_order_status", order_id=0) }}'.replace('0', orderId),
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                data: JSON.stringify({
                    status: newStatus
                }),
                success: function(result) {
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('更新失败：' + result.error);
                    }
                },
                error: function(xhr, status, error) {
                    alert('更新失败：' + error);
                }
            });
        });
        
        $('#confirmStatusUpdate').click(function() {
            var newStatus = $('#orderStatus').val();
            
            $.ajax({
                url: '{{ url_for("main.update_order_status", order_id=0) }}'.replace('0', statusOrderId),
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                data: JSON.stringify({
                    status: newStatus
                }),
                success: function(result) {
                    if (result.success) {
                        $('#statusModal').modal('hide');
                        location.reload();
                    } else {
                        alert('更新失败：' + result.error);
                    }
                },
                error: function(xhr, status, error) {
                    alert('更新失败：' + error);
                }
            });
        });
        
        // 全选/取消全选功能
        $('#selectAll').change(function() {
            $('.order-checkbox').prop('checked', this.checked);
            toggleBatchButtons();
        });
        
        // 单个复选框变化时的处理
        $(document).on('change', '.order-checkbox', function() {
            var totalCheckboxes = $('.order-checkbox').length;
            var checkedCheckboxes = $('.order-checkbox:checked').length;
            
            $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes);
            toggleBatchButtons();
        });
        
        // 显示/隐藏批量操作按钮
         function toggleBatchButtons() {
             var checkedCount = $('.order-checkbox:checked').length;
             if (checkedCount > 0) {
                 $('#batchStatusBtn').show();
                 $('#batchDeleteBtn').show();
             } else {
                 $('#batchStatusBtn').hide();
                 $('#batchDeleteBtn').hide();
             }
         }
        
        // 批量修改状态功能
         $('#batchStatusBtn').click(function() {
             var selectedIds = [];
             $('.order-checkbox:checked').each(function() {
                 selectedIds.push($(this).data('order-id'));
             });
             
             if (selectedIds.length === 0) {
                 alert('请选择要修改状态的订单');
                 return;
             }
             
             $('#selectedCount').text(selectedIds.length);
             $('#batchStatusModal').modal('show');
         });
         
         // 确认批量修改状态
         $('#confirmBatchStatusUpdate').click(function() {
             var selectedIds = [];
             $('.order-checkbox:checked').each(function() {
                 selectedIds.push($(this).data('order-id'));
             });
             
             var newStatus = $('#batchOrderStatus').val();
             
             // 获取CSRF token
             var csrfToken = $('meta[name=csrf-token]').attr('content');
             if (!csrfToken) {
                 csrfToken = $('input[name="csrf_token"]').val();
             }
             
             $.ajax({
                 url: '{{ url_for("main.batch_update_status") }}',
                 type: 'POST',
                 contentType: 'application/json',
                 headers: {
                     'X-CSRFToken': csrfToken,
                     'X-Requested-With': 'XMLHttpRequest'
                 },
                 data: JSON.stringify({
                     order_ids: selectedIds,
                     status: newStatus
                 }),
                 success: function(result) {
                     if (result.success) {
                         $('#batchStatusModal').modal('hide');
                         location.reload();
                     } else {
                         alert('修改失败：' + result.error);
                     }
                 },
                 error: function(xhr, status, error) {
                     alert('修改失败：' + error);
                 }
             });
         });
         
         // 批量删除功能
         $('#batchDeleteBtn').click(function() {
             var selectedIds = [];
             $('.order-checkbox:checked').each(function() {
                 selectedIds.push($(this).data('order-id'));
             });
             
             if (selectedIds.length === 0) {
                 alert('请选择要删除的订单');
                 return;
             }
             
             if (confirm('确定要删除选中的 ' + selectedIds.length + ' 个订单吗？此操作不可恢复。')) {
                 // 获取CSRF token
                 var csrfToken = $('meta[name=csrf-token]').attr('content');
                 if (!csrfToken) {
                     csrfToken = $('input[name="csrf_token"]').val();
                 }
                 
                 $.ajax({
                     url: '{{ url_for("main.batch_delete_orders") }}',
                     type: 'POST',
                     contentType: 'application/json',
                     headers: {
                         'X-CSRFToken': csrfToken,
                         'X-Requested-With': 'XMLHttpRequest'
                     },
                     data: JSON.stringify({
                         order_ids: selectedIds
                     }),
                     success: function(result) {
                         if (result.success) {
                             location.reload();
                         } else {
                             alert('删除失败：' + result.error);
                         }
                     },
                     error: function(xhr, status, error) {
                         alert('删除失败：' + error);
                     }
                 });
             }
         });

    });
</script>
{% endblock %}